// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// PostgreSQL枚举定义
enum UserRole {
  USER
  AGENT
  ADMIN
}

enum KycStatus {
  PENDING
  APPROVED
  REJECTED
  EXPIRED
}

enum OrderStatus {
  PENDING
  SUCCESS
  FAILED
  CANCELED
}

enum PositionStatus {
  ACTIVE
  REDEEMING
  CLOSED
  DEFAULTED
}

enum CommissionType {
  REFERRAL
  AGENT
}

enum CommissionStatus {
  PENDING
  READY
  PAID
  FAILED
}

enum WithdrawalStatus {
  PENDING
  REVIEWING
  APPROVED
  REJECTED
  PROCESSING
  COMPLETED
  FAILED
  CANCELED
}

enum WithdrawalType {
  EARNINGS
  PRINCIPAL
  COMMISSION
}

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

// 用户表
model User {
  id              String    @id @default(cuid())
  email           String?   @unique
  passwordHash    String?   @map("password_hash")
  role            UserRole  @default(USER)
  referralCode    String    @unique @map("referral_code")
  referredById    String?   @map("referred_by_id")
  agentId         String?   @map("agent_id")
  kycStatus       KycStatus @default(PENDING) @map("kyc_status")
  kycData         Json?     @map("kyc_data")
  isActive        Boolean   @default(true) @map("is_active")
  lastLoginAt     DateTime? @map("last_login_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // 关系
  referredBy      User?         @relation("UserReferral", fields: [referredById], references: [id])
  referrals       User[]        @relation("UserReferral")
  agent           User?         @relation("UserAgent", fields: [agentId], references: [id])
  agentUsers      User[]        @relation("UserAgent")
  wallets         Wallet[]
  orders          Order[]
  referredOrders  Order[]       @relation("OrderReferrer")
  agentOrders     Order[]       @relation("OrderAgent")
  positions       Position[]
  payouts         Payout[]
  commissions     Commission[]
  auditLogs       AuditLog[]
  withdrawals     Withdrawal[]
  notifications   Notification[]
  systemLogs      SystemLog[]

  @@map("users")
  @@index([email])
  @@index([referralCode])
  @@index([referredById])
  @@index([agentId])
  @@index([createdAt])
}

// 钱包表
model Wallet {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  chainId   Int      @map("chain_id")
  address   String
  isPrimary Boolean  @default(false) @map("is_primary")
  label     String?
  createdAt DateTime @default(now()) @map("created_at")

  // 关系
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([chainId, address])
  @@map("wallets")
  @@index([userId])
  @@index([address])
}

// 产品表
model Product {
  id            String    @id @default(cuid())
  symbol        String    @unique
  name          String
  description   String?
  minAmount     Decimal   @map("min_amount")
  maxAmount     Decimal?  @map("max_amount")
  aprBps        Int       @map("apr_bps") // 年化收益率(基点)
  lockDays      Int       @map("lock_days")
  nftTokenId    Int?      @unique @map("nft_token_id")
  nftMetadata   Json?     @map("nft_metadata")
  totalSupply   Int?      @map("total_supply") // 总供应量限制
  currentSupply Int       @default(0) @map("current_supply") // 当前已售数量
  isActive      Boolean   @default(true) @map("is_active")
  startsAt      DateTime  @map("starts_at")
  endsAt        DateTime? @map("ends_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // 关系
  orders        Order[]
  positions     Position[]

  @@map("products")
  @@index([symbol])
  @@index([isActive])
  @@index([startsAt])
  @@index([endsAt])
}

// 订单表
model Order {
  id            String      @id @default(cuid())
  userId        String      @map("user_id")
  productId     String      @map("product_id")
  usdtAmount    Decimal     @map("usdt_amount")
  platformFee   Decimal     @default(0) @map("platform_fee")
  txHash        String?     @map("tx_hash")
  status        OrderStatus @default(PENDING)
  referrerId    String?     @map("referrer_id")
  agentId       String?     @map("agent_id")
  failureReason String?     @map("failure_reason")
  metadata      Json?       // 额外的订单元数据
  createdAt     DateTime    @default(now()) @map("created_at")
  confirmedAt   DateTime?   @map("confirmed_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")

  // 关系
  user          User         @relation(fields: [userId], references: [id])
  product       Product      @relation(fields: [productId], references: [id])
  referrer      User?        @relation("OrderReferrer", fields: [referrerId], references: [id])
  agent         User?        @relation("OrderAgent", fields: [agentId], references: [id])
  positions     Position[]
  commissions   Commission[]

  @@map("orders")
  @@index([userId, status])
  @@index([productId])
  @@index([txHash])
  @@index([createdAt])
  @@index([status])
}

// 持仓表
model Position {
  id             String         @id @default(cuid())
  userId         String         @map("user_id")
  productId      String         @map("product_id")
  orderId        String         @map("order_id")
  principal      Decimal       
  startDate      DateTime       @map("start_date")
  endDate        DateTime       @map("end_date")
  nextPayoutAt   DateTime?      @map("next_payout_at")
  nftTokenId     Int?           @map("nft_token_id")
  nftTokenUri    String?        @map("nft_token_uri")
  status         PositionStatus @default(ACTIVE)
  metadata       Json?          // 持仓相关元数据
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")

  // 关系
  user           User       @relation(fields: [userId], references: [id])
  product        Product    @relation(fields: [productId], references: [id])
  order          Order      @relation(fields: [orderId], references: [id])
  payouts        Payout[]

  @@map("positions")
  @@index([userId, status])
  @@index([productId])
  @@index([orderId])
  @@index([nextPayoutAt])
  @@index([endDate])
  @@index([status])
}

// 收益分发表
model Payout {
  id              String    @id @default(cuid())
  userId          String    @map("user_id")
  positionId      String    @map("position_id")
  amount          Decimal  
  periodStart     DateTime  @map("period_start")
  periodEnd       DateTime  @map("period_end")
  isClaimable     Boolean   @default(false) @map("is_claimable")
  claimedAt       DateTime? @map("claimed_at")
  claimTxHash     String?   @map("claim_tx_hash")
  merkleIndex     Int?      @map("merkle_index")
  merkleProof     Json?     @map("merkle_proof")
  batchId         String?   @map("batch_id")
  distributionTx  String?   @map("distribution_tx")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // 关系
  user            User      @relation(fields: [userId], references: [id])
  position        Position  @relation(fields: [positionId], references: [id])

  @@map("payouts")
  @@index([userId, isClaimable])
  @@index([positionId])
  @@index([batchId])
  @@index([periodStart])
  @@index([isClaimable])
}

// 佣金表
model Commission {
  id                String           @id @default(cuid())
  userId            String           @map("user_id")
  orderId           String           @map("order_id")
  basisAmount       Decimal          @map("basis_amount") // 计算基数
  rateBps           Int              @map("rate_bps") // 佣金比例(基点)
  amount            Decimal         
  commissionType    CommissionType   @map("commission_type")
  status            CommissionStatus @default(PENDING)
  settledAt         DateTime?        @map("settled_at")
  settlementTxHash  String?          @map("settlement_tx_hash")
  batchId           String?          @map("batch_id")
  metadata          Json?            // 佣金相关元数据
  createdAt         DateTime         @default(now()) @map("created_at")
  updatedAt         DateTime         @updatedAt @map("updated_at")

  // 关系
  user              User             @relation(fields: [userId], references: [id])
  order             Order            @relation(fields: [orderId], references: [id])

  @@map("commissions")
  @@index([userId, commissionType])
  @@index([orderId])
  @@index([status])
  @@index([batchId])
  @@index([createdAt])
}

// 审计日志表
model AuditLog {
  id           String    @id @default(cuid())
  actorId      String?   @map("actor_id")
  actorType    String    @default("USER") @map("actor_type")
  action       String
  resourceType String?   @map("resource_type")
  resourceId   String?   @map("resource_id")
  ipAddress    String?   @map("ip_address")
  userAgent    String?   @map("user_agent")
  metadata     Json?
  createdAt    DateTime  @default(now()) @map("created_at")

  // 关系
  actor        User?     @relation(fields: [actorId], references: [id])

  @@map("audit_logs")
  @@index([actorId, createdAt])
  @@index([action, createdAt])
  @@index([resourceType, resourceId])
  @@index([createdAt])
}

// 系统配置表
model SystemConfig {
  id        String   @id @default(cuid())
  key       String   @unique
  value     Json
  category  String?
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("system_configs")
  @@index([category])
}

// 提现表
model Withdrawal {
  id                String           @id @default(cuid())
  userId            String           @map("user_id")
  amount            Decimal         
  withdrawalType    WithdrawalType   @map("withdrawal_type")
  status            WithdrawalStatus @default(PENDING)
  walletAddress     String           @map("wallet_address")
  chainId           Int              @map("chain_id")
  platformFee       Decimal          @default(0) @map("platform_fee")
  actualAmount      Decimal          @map("actual_amount") // 扣除手续费后实际提现金额
  txHash            String?          @map("tx_hash")
  blockNumber       Int?             @map("block_number")
  gasUsed           Int?             @map("gas_used")
  gasFee            Decimal?         @map("gas_fee")
  
  // 风险评估字段
  riskScore         Int              @default(0) @map("risk_score") // 0-100风险评分
  riskLevel         RiskLevel        @default(LOW) @map("risk_level")
  riskFactors       Json?            @map("risk_factors") // 风险因素详情
  autoApproved      Boolean          @default(false) @map("auto_approved")
  
  // 审核相关
  reviewerId        String?          @map("reviewer_id")
  reviewedAt        DateTime?        @map("reviewed_at")
  reviewNotes       String?          @map("review_notes")
  rejectionReason   String?          @map("rejection_reason")
  
  // 处理相关
  processedAt       DateTime?        @map("processed_at")
  processedBy       String?          @map("processed_by")
  batchId           String?          @map("batch_id")
  
  // 时间戳
  requestedAt       DateTime         @default(now()) @map("requested_at")
  scheduledAt       DateTime?        @map("scheduled_at") // 计划处理时间
  completedAt       DateTime?        @map("completed_at")
  createdAt         DateTime         @default(now()) @map("created_at")
  updatedAt         DateTime         @updatedAt @map("updated_at")
  
  // KYC和合规
  kycVerified       Boolean          @default(false) @map("kyc_verified")
  amlCheckPassed    Boolean          @default(false) @map("aml_check_passed")
  complianceNotes   String?          @map("compliance_notes")
  
  // 元数据
  metadata          Json?            // 额外信息，如IP地址、设备信息等
  internalNotes     String?          @map("internal_notes") // 内部备注

  // 关系
  user              User             @relation(fields: [userId], references: [id])

  @@map("withdrawals")
  @@index([userId, status])
  @@index([status, riskLevel])
  @@index([requestedAt])
  @@index([reviewerId])
  @@index([batchId])
  @@index([walletAddress])
  @@index([txHash])
}

// 批次处理记录表
model BatchJob {
  id          String    @id @default(cuid())
  type        String    // PAYOUT_DISTRIBUTION, COMMISSION_SETTLEMENT, WITHDRAWAL_PROCESSING等
  status      String    @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED
  parameters  Json?     // 批次参数
  result      Json?     // 处理结果
  errorMsg    String?   @map("error_msg")
  processedAt DateTime? @map("processed_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@map("batch_jobs")
  @@index([type, status])
  @@index([createdAt])
}

// 系统告警表
model Alert {
  id          String    @id @default(cuid())
  title       String
  message     String
  severity    String    // LOW, MEDIUM, HIGH, CRITICAL
  status      String    @default("TRIGGERED") // TRIGGERED, ACKNOWLEDGED, RESOLVED
  module      String    // 告警来源模块
  category    String?   // 告警分类
  metadata    Json?     // 告警元数据
  resolvedBy  String?   @map("resolved_by")
  resolvedAt  DateTime? @map("resolved_at")
  resolution  String?   // 解决方案
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@map("alerts")
  @@index([status, severity])
  @@index([module, createdAt])
  @@index([createdAt])
}

// 通知表
model Notification {
  id          String    @id @default(cuid())
  userId      String?   @map("user_id")
  type        String    // ORDER_APPROVED, COMMISSION_PAYMENT, SYSTEM_MAINTENANCE等
  title       String
  message     String
  priority    String    @default("MEDIUM") // LOW, MEDIUM, HIGH, URGENT
  status      String    @default("UNREAD") // UNREAD, READ, DELETED
  channels    Json      // 发送渠道 ['EMAIL', 'PUSH', 'SMS']
  data        Json?     // 通知相关数据
  readAt      DateTime? @map("read_at")
  sentAt      DateTime? @map("sent_at")
  deliveredAt DateTime? @map("delivered_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // 关系
  user        User?     @relation(fields: [userId], references: [id])

  @@map("notifications")
  @@index([userId, status])
  @@index([type, createdAt])
  @@index([priority, createdAt])
  @@index([createdAt])
}

// 通知模板表
model NotificationTemplate {
  id          String    @id @default(cuid())
  name        String
  type        String    // 模板类型
  title       String
  content     String    // 模板内容，支持变量替换
  variables   Json      // 模板变量列表
  channels    Json      // 支持的发送渠道
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@map("notification_templates")
  @@index([type, isActive])
}

// 系统日志表
model SystemLog {
  id          String    @id @default(cuid())
  level       String    // ERROR, WARN, INFO, DEBUG
  message     String
  module      String?   // 日志来源模块
  userId      String?   @map("user_id")
  metadata    Json?     // 额外的日志信息
  timestamp   DateTime  @default(now())
  createdAt   DateTime  @default(now()) @map("created_at")

  // 关系
  user        User?     @relation(fields: [userId], references: [id])

  @@map("system_logs")
  @@index([level, timestamp])
  @@index([module, timestamp])
  @@index([userId, timestamp])
  @@index([timestamp])
}

// 报告表
model Report {
  id            String    @id @default(cuid())
  name          String
  type          String    // financial_overview, commission_report等
  status        String    @default("PROCESSING") // PROCESSING, COMPLETED, FAILED
  format        String    // pdf, excel, csv
  size          String?   // 文件大小
  parameters    Json?     // 报告参数
  downloadUrl   String?   @map("download_url")
  expiresAt     DateTime? @map("expires_at")
  generatedBy   String    @map("generated_by")
  generatedAt   DateTime  @default(now()) @map("generated_at")
  progress      Int       @default(0) // 生成进度 0-100
  errorMessage  String?   @map("error_message")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  @@map("reports")
  @@index([type, status])
  @@index([generatedBy, generatedAt])
  @@index([generatedAt])
}